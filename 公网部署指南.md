# 公网部署指南

## 部署选项

### 选项 1: 云服务器（推荐）
- **阿里云 ECS**
- **腾讯云 CVM**
- **AWS EC2**
- **DigitalOcean**
- **Vultr**

### 选项 2: 云平台服务
- **Vercel** (前端) + **Railway/Render** (后端)
- **Heroku**
- **Fly.io**

## 推荐方案：云服务器部署

### 第一步：准备服务器

1. **购买云服务器**
   - 推荐配置：2核4G，带宽 3-5Mbps
   - 操作系统：Ubuntu 22.04 LTS 或 CentOS 7+

2. **配置安全组/防火墙**
   - 开放端口：80, 443, 3001, 22
   - 限制 5432 (PostgreSQL) 仅内网访问

### 第二步：服务器环境配置

#### 1. 安装 Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证
node -v
npm -v
```

#### 2. 安装 PostgreSQL
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE gsjt;
CREATE USER gsjt_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE gsjt TO gsjt_user;
\q
```

#### 3. 安装 Nginx（反向代理）
```bash
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 4. 安装 PM2（进程管理）
```bash
sudo npm install -g pm2
```

### 第三步：上传代码

#### 方法 1: Git 克隆
```bash
cd /var/www
git clone <your-repo-url> gsjt-system
cd gsjt-system
```

#### 方法 2: 使用 SCP 上传
```bash
# 在本地执行
scp -r gsjt-system user@your-server-ip:/var/www/
```

### 第四步：配置应用

#### 1. 安装依赖
```bash
cd /var/www/gsjt-system/backend
npm install --production

cd /var/www/gsjt-system/frontend
npm install
npm run build
```

#### 2. 配置后端环境变量
```bash
cd /var/www/gsjt-system/backend
nano .env
```

`.env` 内容：
```env
# 服务器配置
PORT=3001
HOST=0.0.0.0
NODE_ENV=production

# PostgreSQL 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=gsjt
DB_USER=gsjt_user
DB_PASSWORD=your_strong_password
```

#### 3. 初始化数据库
```bash
cd /var/www/gsjt-system/backend/database
node initTables.js
node importScenarios.js
```

#### 4. 启动后端服务
```bash
cd /var/www/gsjt-system/backend
pm2 start server.js --name gsjt-backend
pm2 save
pm2 startup  # 设置开机自启
```

### 第五步：配置 Nginx 反向代理

```bash
sudo nano /etc/nginx/sites-available/gsjt
```

Nginx 配置：
```nginx
# 后端 API
server {
    listen 80;
    server_name api.yourdomain.com;  # 或使用 IP

    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# 前端应用
server {
    listen 80;
    server_name yourdomain.com;  # 或使用 IP

    root /var/www/gsjt-system/frontend/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/gsjt /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 第六步：配置 SSL 证书（HTTPS）

#### 使用 Let's Encrypt（免费）
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com -d api.yourdomain.com
```

证书会自动续期。

### 第七步：配置前端环境变量

如果前端需要单独配置 API URL：

```bash
cd /var/www/gsjt-system/frontend
nano .env.production
```

内容：
```env
VITE_API_URL=https://api.yourdomain.com/api
# 或如果前后端同域
VITE_API_URL=/api
```

重新构建：
```bash
npm run build
```

### 第八步：安全配置

#### 1. 配置防火墙
```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

#### 2. 修改 PostgreSQL 配置（仅本地访问）
```bash
sudo nano /etc/postgresql/*/main/pg_hba.conf
```

确保只有本地连接：
```
host    all             all             127.0.0.1/32            scram-sha-256
```

#### 3. 定期备份数据库
```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-gsjt.sh
```

内容：
```bash
#!/bin/bash
BACKUP_DIR="/var/backups/gsjt"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
pg_dump -U gsjt_user -d gsjt > $BACKUP_DIR/gsjt_$DATE.sql
# 保留最近7天的备份
find $BACKUP_DIR -name "gsjt_*.sql" -mtime +7 -delete
```

设置定时任务：
```bash
sudo chmod +x /usr/local/bin/backup-gsjt.sh
sudo crontab -e
# 添加：每天凌晨2点备份
0 2 * * * /usr/local/bin/backup-gsjt.sh
```

## 快速部署脚本

我还可以为您创建一个自动化部署脚本，简化部署过程。

## 注意事项

1. **安全性**
   - 使用强密码
   - 定期更新系统和依赖
   - 配置防火墙
   - 使用 HTTPS

2. **性能优化**
   - 启用 Nginx 缓存
   - 使用 CDN 加速静态资源
   - 配置数据库连接池

3. **监控**
   - 使用 PM2 监控应用状态
   - 配置日志轮转
   - 设置告警

## 测试部署

部署完成后，访问：
- 前端：`https://yourdomain.com`
- API：`https://yourdomain.com/api/results`

## 需要帮助？

如果需要，我可以：
1. 创建自动化部署脚本
2. 提供更详细的配置示例
3. 帮助解决部署过程中的问题
